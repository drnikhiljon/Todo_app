# database.py
import psycopg2
from psycopg2 import Error
import pandas as pd
import datetime # Import datetime for handling timestamp objects

# Replace with your PostgreSQL credentials
DB_HOST = "localhost"
DB_NAME = "Todo_Dashboard"
DB_USER = "postgres"
DB_PASSWORD = "Admin"

def get_db_connection():
    conn = None
    try:
        conn = psycopg2.connect(
            host=DB_HOST,
            database=DB_NAME,
            user=DB_USER,
            password=DB_PASSWORD
        )
        return conn
    except Error as e:
        print(f"Error connecting to PostgreSQL: {e}")
        return None

def create_todo(task_name, start_time, end_time, details, media_data=None, media_filename=None, media_mimetype=None):
    conn = get_db_connection()
    if conn:
        try:
            cursor = conn.cursor()
            query = """
            INSERT INTO todos (task_name, start_time, end_time, details, media_data, media_filename, media_mimetype)
            VALUES (%s, %s, %s, %s, %s, %s, %s) RETURNING id;
            """
            cursor.execute(query, (task_name, start_time, end_time, details, media_data, media_filename, media_mimetype))
            new_id = cursor.fetchone()[0]
            conn.commit()
            cursor.close()
            conn.close()
            return new_id
        except Error as e:
            print(f"Error creating todo: {e}")
            return None
    return None

def get_all_todos():
    conn = get_db_connection()
    if conn:
        try:
            # Fetch all columns including new media columns
            df = pd.read_sql_query("SELECT id, task_name, start_time, end_time, details, status, media_data, media_filename, media_mimetype FROM todos ORDER BY id DESC;", conn)
            conn.close()
            return df
        except Error as e:
            print(f"Error fetching todos: {e}")
            return pd.DataFrame()
    return pd.DataFrame()

def get_todo_by_id(todo_id):
    conn = get_db_connection()
    if conn:
        try:
            cursor = conn.cursor()
            # Select all columns explicitly to maintain order and access by index if needed
            query = "SELECT id, task_name, start_time, end_time, details, status, media_data, media_filename, media_mimetype FROM todos WHERE id = %s;"
            cursor.execute(query, (todo_id,))
            todo = cursor.fetchone()
            cursor.close()
            conn.close()
            return todo
        except Error as e:
            print(f"Error fetching todo by ID: {e}")
            return None
    return None

def update_todo(todo_id, task_name, start_time, end_time, details, status, media_data=None, media_filename=None, media_mimetype=None):
    conn = get_db_connection()
    if conn:
        try:
            cursor = conn.cursor()
            query = """
            UPDATE todos
            SET task_name = %s, start_time = %s, end_time = %s, details = %s, status = %s,
                media_data = %s, media_filename = %s, media_mimetype = %s
            WHERE id = %s;
            """
            cursor.execute(query, (task_name, start_time, end_time, details, status,
                                    media_data, media_filename, media_mimetype, todo_id))
            conn.commit()
            cursor.close()
            conn.close()
            return True
        except Error as e:
            print(f"Error updating todo: {e}")
            return False
    return False

def delete_todo(todo_id):
    conn = get_db_connection()
    if conn:
        try:
            cursor = conn.cursor()
            query = "DELETE FROM todos WHERE id = %s;"
            cursor.execute(query, (todo_id,))
            conn.commit()
            cursor.close()
            conn.close()
            return True
        except Error as e:
            print(f"Error deleting todo: {e}")
            return False
    return False
